{
    "name": "Power of attorney",
    "data": [
        {
            "Name": "default_menu",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "MenuItem(Title:Attorney list, Page:attorney_list, Icon:\"icon-list\")",
            "Type": "menu"
        },
        {
            "Name": "power_of_attorney",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"params\",\n        \"type\": \"json\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"address\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"date_expiration\",\n        \"type\": \"datetime\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_attorney\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"date_last_transaction\",\n        \"type\": \"datetime\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rid\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"type\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"delete\",\n        \"type\": \"character\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"contract\",\n        \"type\": \"varchar\"\n    }\n]",
            "Permissions": "{\"insert\": \"ContractAccess(\\\"AttorneyStore\\\",\\\"MultiwalletCreate\\\")\", \"update\": \"ContractAccess(\\\"AttorneyStore\\\",\\\"attorney_Del\\\",\\\"TokenTransferCheckAccess\\\")\", \"new_column\": \"ContractConditions(\\\"MainCondition\\\")\"}",
            "Type": "tables"
        },
        {
            "Name": "attorney_contracts",
            "Conditions": "true",
            "Value": "TokenTransfer,Test",
            "Type": "app_params"
        },
        {
            "Name": "attorney_add",
            "Conditions": "true",
            "Value": "DBFind(applications).Columns(\"name,id\").Where({name:\"Power of attorney\"}).Vars(application)\r\nAppParam(App:#application_id#, Name: attorney_contracts, Source: src_contracts)\r\n\r\nSetTitle($attorney_add$)\r\n\r\nDBFind(roles,src_roles)\r\nDBFind(power_of_attorney).WhereId(#attorney_id#).Vars(poa)\r\nJsonToSource(src_params, #poa_params#)\r\n\r\nDiv(content-wrapper){\r\n    Div(breadcrumb){\r\n        LinkPage(Body: $attorney_list$, Page: attorney_list)\r\n        Span(/, mh)\r\n        Span($attorney_add$, text-muted)\r\n    }\r\n    Form(row){\r\n        Div(col-md-6){\r\n            Div(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(general_info)\r\n                }\r\n                Div(panel-body){\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(attorney_id))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                Input(Name: MemberId)\r\n                            }\r\n                        }\r\n                    }\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(contract))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                Select(Name: Name, Source: src_contracts, NameColumn: name, ValueColumn: name)\r\n                            }\r\n                        }\r\n                    }\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(expiration_date))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                Input(Name: ExpireAt, Type:date)\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                Div(panel-footer text-right){\r\n                    Div(pull-left){\r\n                        Button(Body: LangRes(back), Class: btn, Page: attorney_list)\r\n                    }\r\n                    Button(Body: LangRes(issue), Class: btn btn-primary, Page: attorney_list, Contract: AttorneyStore)\r\n                }\r\n            }\r\n        }\r\n        Div(col-md-6){\r\n            Div(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(power_of_attorney_params)\r\n                }\r\n                Div(panel-body){\r\n                    Div(row text-muted){\r\n                        Div(col-md-3){\r\n                            Label(LangRes(name))\r\n                        }\r\n                        Div(col-md-8){\r\n                            Label(LangRes(value))\r\n                        }\r\n                    }\r\n                    If(GetVar(current_index)==\"\"){\r\n                        SetVar(current_index,1)\r\n                    }\r\n                    SetVar(prev_index, Calculate(#current_index#-1))\r\n                    SetVar(next_index, Calculate(#current_index#+1))\r\n                    SetVar(hidden,\"hidden\")\r\n                    If(#current_index#>1){\r\n                        SetVar(hidden,)\r\n                    }\r\n\r\n                    Range(params_range, 0, #current_index#)\r\n                    ForList(params_range){\r\n                        Div(list-group-item){\r\n                            Div(row){\r\n                                Div(col-md-3){\r\n                                    Input(Name: Params)\r\n                                }\r\n                                Div(col-md-7){\r\n                                    Input(Name: Values)\r\n                                }\r\n                            }\r\n                        }\r\n                        Div(col-md-2){\r\n                        }\r\n                    }\r\n                    Div(text-right){\r\n                        Button(Class: fa fa-minus btn btn-default #hidden#, PageParams: \"current_index=#prev_index#\", Page: attorney_add)\r\n                        Button(Class: fa fa-plus btn btn-info, Page: attorney_add, PageParams: \"current_index=#next_index#\")\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "attorney_edit",
            "Conditions": "true",
            "Value": "DBFind(applications).Columns(\"name,id\").Where({name:\"Power of attorney\"}).Vars(application)\nAppParam(App:#application_id#, Name: attorney_contracts, Source: src_contracts)\n\nSetTitle($attorney_edit$)\n\nDBFind(roles, src_roles)\nDBFind(power_of_attorney).WhereId(#AttorneyId#).Vars(poa)\nJsonToSource(src_params, #poa_params#)\n\nDiv(content-wrapper){\n    Div(breadcrumb){\n        LinkPage(Body: $attorney_list$, Page: attorney_list)\n        Span(/, mh)\n        Span($attorney_edit$, text-muted)\n    }\n    Form(row){\n        Div(col-md-6){\n            Div(panel panel-primary){\n                Div(panel-heading){\n                    LangRes(general_info)\n                }\n                Div(panel-body){\n                    Div(list-group-item){\n                        Div(row){\n                            Div(col-md-3 text-right){\n                                Label(LangRes(role))\n                            }\n                            Div(col-md-9 text-left){\n                                Select(Source: src_roles, NameColumn: role_name, ValueColumn: id, Value: #poa_role_id_attorney#)\n                            }\n                        }\n                    }\n                    Div(list-group-item){\n                        Div(row){\n                            Div(col-md-3 text-right){\n                                Label(LangRes(AttorneyId))\n                            }\n                            Div(col-md-9 text-left){\n                                Input(Name: AttorneyId, Value: #poa_key_id_attorney#)\n                            }\n                        }\n                    }\n                    Div(list-group-item){\n                        Div(row){\n                            Div(col-md-3 text-right){\n                                Label(LangRes(contract))\n                            }\n                            Div(col-md-9 text-left){\n                                Select(Name: Name, Source: src_contracts, NameColumn: name, ValueColumn: name, Value: #poa_contract#)\n                            }\n                        }\n                    }\n                    Div(list-group-item){\n                        Div(row){\n                            Div(col-md-3 text-right){\n                                Label(LangRes(expiration_date))\n                            }\n                            Div(col-md-9 text-left){\n                                Input(Type:date, Name: ExpireAt, Value: DateTime(#poa_date_expiration#, \"YYYY-MM-DD\"))\n                            }\n                        }\n                    }\n                }\n            }\n\n        }\n        Div(col-md-6){\n            Div(panel panel-primary){\n                Div(panel-heading){\n                    LangRes(power_of_attorney_params)\n                }\n                Div(panel-body){\n                    Div(row text-muted){\n                        Div(col-md-3){\n                            Label(LangRes(name))\n                        }\n                        Div(col-md-7){\n                            Label(LangRes(value))\n                        }\n                    }\n                    ForList(src_params){\n                        Div(list-group-item){\n                            Div(row){\n                                Div(col-md-3){\n                                    Input(Name: Params, Value: #key#)\n                                }\n                                Div(col-md-7){\n                                    Input(Name: Values, Value: #value#)\n                                }\n                                Div(col-md-2){\n                                    Button(Class: fa fa-trash btn btn-link, PageParams: \"AttorneyId=#AttorneyId#,current_index=#current_index#\", Page: attorney_edit, Contract: AttorneyParamDelete, Params: \"AttorneyId=#AttorneyId#,Param=#key#\")\n                                }\n                            }\n                        }\n                    }\n                    If(GetVar(current_index)==\"\"){\n                        SetVar(current_index, 1)\n                    }\n                    SetVar(prev_index, Calculate(#current_index#-1))\n                    SetVar(next_index, Calculate(#current_index#+1))\n                    SetVar(hidden,\"hidden\")\n                    If(#current_index#>1){\n                        SetVar(hidden,)\n                    }\n                    Range(params_range, 0, #current_index#)\n                    ForList(params_range){\n                        Div(list-group-item){\n                            Div(row){\n                                Div(col-md-3){\n                                    Input(Name: Params)\n                                }\n                                Div(col-md-7){\n                                    Input(Name: Values)\n                                }\n                                Div(col-md-2){\n                                    If(And(#index# > 0, Calculate(#index# + 1)==#current_index#)){\n                                    }\n                                }\n                            }\n                        }\n                    }\n                    Div(text-right){\n                        Button(Class: fa fa-minus btn btn-default #hidden#, Page: attorney_edit, PageParams: \"AttorneyId=#AttorneyId#,current_index=#prev_index#\")\n                        LinkPage(Class:fa fa-plus btn btn-info, Page: attorney_edit, PageParams: \"AttorneyId=#AttorneyId#,current_index=#next_index#\")\n                    }\n                }\n                Div(panel-footer text-right){\n                    Button(Body: LangRes(save), Class: btn btn-primary, Page: attorney_list, Contract: AttorneyStore, Params: \"Id=#AttorneyId#\")\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "attorney_list",
            "Conditions": "true",
            "Value": "SetTitle($attorney_list$)\nAddToolButton(Page: attorney_add, Title:$attorney_add$)\n\nDBFind(power_of_attorney, src_attorney).Where({address:#key_id#, delete:0}).Custom(_date_expiration){\n    DateTime(#date_expiration#,\"YYYY-MM-DD\")\n}.Custom(_action){\n    Button(Body: View, Class: btn btn-primary, Page: attorney_view, PageParams: \"AttorneyId=#id#\")\n}.Custom(_key_id_attorney){\n    LinkPage(Body: Address(#key_id_attorney#), Page: profile_view, PageParams: \"v_member_id=#key_id_attorney#\")\n}\n\nDiv(content-wrapper){\n    Form(panel panel-primary){\n        Div(panel-body){\n            Div(table-responsive){\n                Table(src_attorney, \"Contract=contract,Attorney=_key_id_attorney,Expiration date=_date_expiration,=_action\")\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "attorney_view",
            "Conditions": "true",
            "Value": "If(#notific_id#>0){\r\n    DBFind(Name: notifications, Source: src_notifications).Columns(\"id,page_params->id\").Where(\"id=#notific_id#\").Vars(notific)\r\n    SetVar(attorney_id, #notific_page_params_id#)\r\n}\r\n\r\nSetTitle($attorney_view$)\r\n\r\nDBFind(Name:power_of_attorney).WhereId(#attorney_id#).Vars(power_of_attorney)\r\nJsonToSource(Source: src_params, Data: #power_of_attorney_params#)\r\n\r\nDiv(content-wrapper){\r\n    Div(breadcrumb){\r\n        LinkPage($attorney$, attorney_list)\r\n        Span(/).Style(margin-right: 10px; margin-left: 10px;)\r\n        Span(Class: text-muted, Body: $attorney_view$)\r\n    }\r\n    Form(row){\r\n        Div(col-md-10 col-lg-offset-1){\r\n            Div(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(attorney_general_info)\r\n                }\r\n                Div(panel-body){\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(attorney))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                #power_of_attorney_key_id_attorney#\r\n                            }\r\n                        }\r\n                    }\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(contract))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                #power_of_attorney_contract#\r\n                            }\r\n                        }\r\n                    }\r\n                    Div(list-group-item){\r\n                        Div(row){\r\n                            Div(col-md-3 text-right){\r\n                                Label(LangRes(expiration_date))\r\n                            }\r\n                            Div(col-md-9 text-left){\r\n                                DateTime(#power_of_attorney_date_expiration#, \"YYYY-MM-DD\")\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n            Div(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(attorney_params)\r\n                }\r\n                Div(panel-body){\r\n                    Div(row text-muted){\r\n                        Div(col-md-3 mt-lg){\r\n                            Label(LangRes(name))\r\n                        }\r\n                        Div(col-md-8 mt-lg){\r\n                            Label(LangRes(value))\r\n                        }\r\n                    }\r\n                    ForList(Source: src_params){\r\n                        Div(col-md-3 mt-lg){\r\n                            #key#\r\n                        }\r\n                        Div(col-md-8 mt-lg){\r\n                            #value#\r\n                        }\r\n                    }\r\n                }\r\n                Div(panel-footer text-right){\r\n                    If(#notific_id#>0){\r\n                        Button(Body: LangRes(informed), Class: btn btn-success, Contract: notifications_Close, Params: \"notific_id=#notific_id#\")\r\n                    }\r\n                    Button(Body: LangRes(edit), Class: btn btn-primary, Page: attorney_edit, PageParams: \"attorney_id=#attorney_id#\")\r\n                    Button(Body: LangRes(delete), Class: btn btn-danger, Contract: AttorneyDel, Params: \"Id=#attorney_id#\", Page: attorney_list)\r\n                }\r\n            }\r\n        }\r\n    }\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "AttorneyCondition",
            "Conditions": "true",
            "Value": "contract AttorneyCondition {\n    data {\n        Name string\n        Wallet int\n    }\n\n    conditions {\n        var attorney_id int\n        attorney_id = Int(DBFind(\"power_of_attorney\").Where({delete:0, \"contract\":$Name, \"address\":$Wallet, \"$or\":[{key_id_attorney:$key_id}, {rid:$role_id}]}).One(\"id\"))\n        if attorney_id == 0{\n            warning Sprintf(\"You don't have access to wallet %s\", $Wallet)\n        }\n        $result = attorney_id\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "AttorneyDelete",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract AttorneyDelete {\n    data {\n        AttorneyId int\n    }\n    conditions {\n        if !DBFind(\"power_of_attorney\").Where({id:$AttorneyId, \"address\":$key_id}).One(\"id\") {\n            warning \"Power of attorney does not exists\"\n        }\n    }\n    action {\n        DBUpdate(\"power_of_attorney\", $AttorneyId, {delete:$time})\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "AttorneyParamDelete",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract AttorneyParamDelete {\n    data {\n        AttorneyId int\n        Param string\n    }\n    conditions {\n        $attorney = DBFind(\"power_of_attorney\").Where({id:$AttorneyId, \"address\":$key_id}).Row()\n        if !$attorney {\n            warning \"Power of attorney does not exists\"\n        }\n    }\n    action {\n        var params newParams map keys array i lenKeys int key string\n        params = JSONDecode($attorney[\"params\"])\n        keys = GetMapKeys(params)\n        lenKeys = Len(keys)\n        while i < lenKeys{\n            key = keys[i]\n            if key != $Param{\n                newParams[key] = params[key]\n            }\n            i = i + 1\n        }\n        DBUpdate(\"power_of_attorney\", $AttorneyId, {params:\"{}\"})\n        DBUpdate(\"power_of_attorney\", $AttorneyId, {params:newParams})\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "AttorneyStore",
            "Conditions": "true",
            "Value": "contract AttorneyStore {\n    data {\n        Id string \"optional\"\n        MemberId int\n        Name string\n        ExpireAt string \"optional\"\n        Params array \"optional\"\n        Values array \"optional\"\n    }\n    conditions {\n        $Id = Int($Id)\n        if $Id > 0 {\n            if !DBFind(\"power_of_attorney\").Where({id:$Id, \"address\":$key_id, delete:0}).One(\"id\") {\n                warning \"Power of attorney does not exists\"\n            }\n        }\n        if !DBFind(\"keys\").WhereId($MemberId).One(\"id\") {\n            warning \"Attorney not found\"\n        }\n        if !DBFind(\"contracts\").Where({name:$Name}).One(\"id\") {\n            warning \"Contract not found\"\n        }\n        if Len($Params) > Len($Values) {\n            error \"Incorrect params list\"\n        }\n    }\n    action {\n        var params map i id lenKeys int\n        lenKeys = Len($Params)\n        while i < lenKeys {\n            params[$Params[i]] = $Values[i]\n            i = i + 1\n        }\n        var m map\n        m[\"key_id_attorney\"] = $MemberId\n        m[\"contract\"] = $Name\n        m[\"date_expiration\"] = $ExpireAt\n        m[\"params\"] = JSONEncode(params)\n        if $Id > 0 {\n            DBUpdate(\"power_of_attorney\", $Id, m)\n        }else{\n            m[\"address\"] = $key_id\n            id = DBInsert(\"power_of_attorney\", m)\n\n            var n map\n            n[\"member_id\"] = $MemberId\n            n[\"sender\"] = 1\n            n[\"text_header\"] = \"You got new power of attorney\"\n            n[\"page_name\"] = \"attorney_add\"\n            n[\"params_map\"] = Sprintf(`{\"id\":\"%v\"}`, id)\n            CallContract(\"notifications_Send\", n)\n        }\n    }\n}",
            "Type": "contracts"
        }
    ]
}