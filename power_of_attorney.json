{
    "name": "Power of attorney",
    "data": [
        {
            "Name": "PoaParamsTokensTransfer",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "Div(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(amount_max)\n        Input(Name: Params, Value: amount_max, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(amount_max_day)\n        Input(Name: Params, Value: amount_max_day, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(amount_day)\n        Input(Name: Params, Value: amount_day, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(date_day)\n        Input(Name: Params, Value: date_day, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(amount_max_month)\n        Input(Name: Params, Value: amount_max_month, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(amount_month)\n        Input(Name: Params, Value: amount_month, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}\nDiv(mb row){\n    Div(col-sm-4 mt-sm){\n        LangRes(date_month)\n        Input(Name: Params, Value: date_month, Type:hidden)\n    }\n    Div(col-sm-6){\n        Input(Name: Values)\n    }\n    Div(col-sm-2){\n        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n    }\n}",
            "Type": "blocks"
        },
        {
            "Name": "default_menu",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "MenuItem(Title:Attorney list, Page:poa_list, Icon:\"icon-list\")",
            "Type": "menu"
        },
        {
            "Name": "power_of_attorney",
            "Columns": "[\n    {\n        \"conditions\": \"true\",\n        \"name\": \"params\",\n        \"type\": \"json\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"address\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"date_expiration\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"key_id_attorney\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"date_last_transaction\",\n        \"type\": \"datetime\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"rid\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"type\",\n        \"type\": \"number\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"delete\",\n        \"type\": \"character\"\n    },\n    {\n        \"conditions\": \"true\",\n        \"name\": \"contract\",\n        \"type\": \"varchar\"\n    }\n]",
            "Permissions": "{\"insert\": \"ContractAccess(\\\"PoaStore\\\",\\\"MultiwalletCreate\\\")\", \"update\": \"ContractAccess(\\\"PoaStore\\\",\\\"attorney_Del\\\",\\\"TokenTransferCheckAccess\\\")\", \"new_column\": \"ContractConditions(\\\"MainCondition\\\")\"}",
            "Type": "tables"
        },
        {
            "Name": "attorney_contracts",
            "Conditions": "true",
            "Value": "TokensTransfer",
            "Type": "app_params"
        },
        {
            "Name": "poa_list",
            "Conditions": "true",
            "Value": "SetTitle($poa_list$)\nAddToolButton(Page: poa_store, Title:$attorney_add$)\n\nDBFind(power_of_attorney, src_attorney).Where({address:#key_id#, delete:0}).Custom(_date_expiration){\n    DateTime(#date_expiration#,\"YYYY-MM-DD\")\n}.Custom(_action){\n    Button(Body: View, Class: btn btn-primary, Page: poa_view, PageParams: \"Id=#id#\")\n}.Custom(_key_id_attorney){\n    LinkPage(Body: Address(#key_id_attorney#), Page: profile_view, PageParams: \"v_member_id=#key_id_attorney#\")\n}\n\nDiv(content-wrapper){\n    Form(panel panel-primary){\n        Div(panel-body){\n            Div(table-responsive){\n                Table(src_attorney, \"Contract=contract,Attorney=_key_id_attorney,Expiration date=_date_expiration,=_action\")\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_store",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "DBFind(applications).Columns(\"name,id\").Where({name:\"Power of attorney\"}).Vars(application)\nAppParam(App:#application_id#, Name: attorney_contracts, Source: src_contracts)\nDBFind(roles, src_roles)\nDBFind(keys, src_keys).Where({id:{\"$neq\":#key_id#}}).Custom(_name){\n    DBFind(members).WhereId(#id#).Columns(\"member_name\").Vars(member)\n    If(Or(#member_id#>0,#member_id#<0)){\n        #id# (#member_member_name#)\n    }.Else{\n        #id# (Address(#id#))\n    }\n\n}\n\n\nSetVar(this_page,poa_store)\n\nSetTitle($attorney_add$)\nSetVar(poa_params,).(poa_role_id_attorney,).(poa_key_id_attorney,#key_id#).(poa_contract,).(poa_date_expiration)\nIf(#Id#>0){\n    SetTitle($attorney_edit$)\n    DBFind(power_of_attorney).WhereId(#Id#).Vars(poa)\n    JsonToSource(src_params, #poa_params#)\n}.Else{\n    SetVar(Id,0)\n}\n\nDiv(content-wrapper){\n    Div(breadcrumb){\n        LinkPage(Body: $poa_list$, Page: poa_list)\n        Span(/, mh)\n        Span(#this_page#, text-muted)\n    }\n    Div(row){\n        Div(col-sm-8 col-sm-offset-2 col-lg-6 col-lg-offset-3){\n            Form(panel panel-primary){\n                Div(panel-heading){\n                    LangRes(issue_power_of_attorney)\n                }\n                Div(panel-body){\n                    If(){\n                        Div(form-group){\n                            Div(row){\n                                Div(col-sm-4 text-right){\n                                    Label(LangRes(role))\n                                }\n                                Div(col-sm-8 text-left){\n                                    Select(Name: RoleId, Source: src_roles, NameColumn: role_name, ValueColumn: id, Value: #poa_role_id_attorney#)\n                                }\n                            }\n                        }\n                    }\n                    Div(form-group){\n                        Div(row){\n                            Div(col-sm-4 text-right){\n                                Label(LangRes(attorney_id))\n                            }\n                            Div(col-sm-8 text-left){\n                                Select(Name: MemberId, Source: src_keys, NameColumn: _name, ValueColumn: id, Value: #poa_key_id_attorney#)\n                            }\n                        }\n                    }\n                    Div(form-group){\n                        Div(row){\n                            Div(col-sm-4 text-right){\n                                Label(LangRes(contract))\n                            }\n                            Div(col-sm-8 text-left){\n                                Select(Name: NameContract, Source: src_contracts, NameColumn: name, ValueColumn: name, Value: #poa_contract#)\n                            }\n                        }\n                    }\n                    Div(form-group){\n                        Div(row){\n                            Div(col-sm-4 text-right){\n                                Label(LangRes(expiration_date))\n                            }\n                            Div(col-sm-8 text-left){\n                                Input(Type:date, Name: ExpireAt, Value: DateTime(#poa_date_expiration#, \"YYYY-MM-DD\"))\n                            }\n                        }\n                    }\n                    If(GetVar(current_index)==\"\"){\n                        SetVar(current_index,0)\n                    }\n                    SetVar(prev_index, Calculate(#current_index#-1))\n                    SetVar(next_index, Calculate(#current_index#+1))\n                    SetVar(hidden,\"hidden\")\n                    If(#current_index#>0){\n                        SetVar(hidden,)\n                    }\n                    Div(list-group-item){\n                        Div(clearfix){\n                            Div(h4 pull-left){\n                                LangRes(PoaParamsTokensTransfer)\n                            }\n                            Div(pull-right){\n                                Button(Class: fa fa-minus btn btn-default #hidden#, Page: #this_page#, PageParams: \"Id=#Id#,current_index=#prev_index#\")\n                                LinkPage(Class:fa fa-plus btn btn-info, Page: #this_page#, PageParams: \"Id=#Id#,current_index=#next_index#\")\n                            }\n                        }\n                        If(#Id#>0){\n                            ForList(src_params){\n                                Div(mb row){\n                                    Div(col-sm-4){\n                                        Input(Name: Params, Value: #key#)\n                                    }\n                                    Div(col-sm-6){\n                                        Input(Name: Values, Value: #value#)\n                                    }\n                                    Div(col-sm-2){\n                                        Button(Class: fa fa-trash btn btn-link, PageParams: \"Id=#Id#,current_index=#current_index#\", Page: #this_page#, Contract: PoaParamDelete, Params: \"Id=#Id#,Param=#key#\")\n                                    }\n                                }\n                            }\n                        }.Else{\n                            Include(attorney_default_params)\n                        }\n                        Div(row text-muted text-center #hidden#){\n                            Div(col-sm-4){\n                                Label(LangRes(name))\n                            }\n                            Div(col-sm-6){\n                                Label(LangRes(value))\n                            }\n                        }\n                        Range(params_range, 0, #current_index#)\n                        ForList(params_range){\n                            Div(mb row){\n                                Div(col-sm-4){\n                                    Input(Name: Params)\n                                }\n                                Div(col-sm-6){\n                                    Input(Name: Values)\n                                }\n                            }\n                        }\n                    }\n                }\n                Div(panel-footer text-right){\n                    Button(Body: LangRes(issue), Class: btn btn-primary, Page: poa_list, Contract: PoaStore, Params: \"Id=#Id#\")\n                }\n            }\n        }\n    }\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "poa_view",
            "Conditions": "true",
            "Value": "If(#notific_id#>0){\r\n    DBFind(notifications).Columns(\"id,page_params->id\").Where(\"id=#notific_id#\").Vars(notific)\r\n    SetVar(Id, #notific_page_params_id#)\r\n}\r\n\r\nSetTitle($poa_view$ ##Id#)\r\n\r\nDBFind(power_of_attorney).WhereId(#Id#).Vars(poa)\r\nJsonToSource(src_params, #poa_params#)\r\nSetVar(params_count,0)\r\nForList(src_params){\r\n    SetVar(params_count,Calculate(#params_count#+1))\r\n}\r\nDiv(content-wrapper){\r\n    Div(breadcrumb){\r\n        LinkPage($attorney$, poa_list)\r\n        Span(/,mh)\r\n        Span($poa_view$, text-muted)\r\n    }\r\n    Form(row){\r\n        Div(col-md-10 col-lg-offset-1){\r\n            Div(panel panel-primary){\r\n                Div(panel-heading){\r\n                    LangRes(attorney_info)\r\n                }\r\n                Div(panel-body){\r\n                    Div(row mb){\r\n                        Div(col-sm-4 text-right){\r\n                            Label(LangRes(attorney))\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            #poa_key_id_attorney#\r\n                        }\r\n                    }\r\n                    Div(row mb){\r\n                        Div(col-sm-4 text-right){\r\n                            Label(LangRes(contract))\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            #poa_contract#\r\n                        }\r\n                    }\r\n                    Div(row mb){\r\n                        Div(col-sm-4 text-right){\r\n                            Label(LangRes(expiration_date))\r\n                        }\r\n                        Div(col-sm-8 text-left){\r\n                            DateTime(#poa_date_expiration#, \"YYYY-MM-DD\")\r\n                        }\r\n                    }\r\n                    If(#params_count#>0){\r\n                        Div(h4){\r\n                            LangRes(power_of_attorney_params)\r\n                        }\r\n                        Div(row text-muted text-center){\r\n                            Div(col-sm-4 mt-lg){\r\n                                Label(LangRes(name))\r\n                            }\r\n                            Div(col-sm-8 mt-lg){\r\n                                Label(LangRes(value))\r\n                            }\r\n                        }\r\n                        ForList(src_params){\r\n                            Div(col-sm-4 mt-lg){\r\n                                #key#\r\n                            }\r\n                            Div(col-sm-8 mt-lg){\r\n                                #value#\r\n                            }\r\n                        }\r\n                    }\r\n                }\r\n                Div(panel-footer text-left){\r\n                    Button(Body: LangRes(back), Class: btn, Page: poa_list)\r\n                    Div(pull-right){\r\n                        If(#notific_id#>0){\r\n                            Button(Body: LangRes(informed), Class: btn btn-success, Contract: notifications_Close, Params: \"notific_id=#notific_id#\")\r\n                        }\r\n                        If(#poa_address#==#key_id#){\r\n                            Button(Body: LangRes(edit), Class: btn btn-primary, Page: poa_store, PageParams: \"Id=#Id#\")\r\n                            Button(Body: LangRes(delete), Class: btn btn-danger, Contract: PoaDelete, Params: \"Id=#Id#\", Page: poa_list)\r\n                        }\r\n                    }\r\n                }\r\n            }\r\n        }\r\n    }\r\n}",
            "Menu": "default_menu",
            "Type": "pages"
        },
        {
            "Name": "PoaCondition",
            "Conditions": "true",
            "Value": "contract PoaCondition {\n    data {\n        Name string\n        Wallet int\n    }\n\n    conditions {\n        var attorney_id int\n        attorney_id = Int(DBFind(\"power_of_attorney\").Where({delete:0, \"contract\":$Name, \"address\":$Wallet, \"$or\":[{key_id_attorney:$key_id}, {rid:$role_id}]}).One(\"id\"))\n        if attorney_id == 0{\n            warning Sprintf(\"You don't have access to wallet %s\", $Wallet)\n        }\n        $result = attorney_id\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaDelete",
            "Conditions": "true",
            "Value": "contract PoaDelete {\n    data {\n        Id int\n    }\n    conditions {\n        if !DBFind(\"power_of_attorney\").Where({id:$AttorneyId, \"address\":$key_id}).One(\"id\") {\n            warning \"Power of attorney does not exists\"\n        }\n    }\n    action {\n        DBUpdate(\"power_of_attorney\", $AttorneyId, {delete:$time})\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaParamDelete",
            "Conditions": "ContractConditions(\"MainCondition\")",
            "Value": "contract PoaParamDelete {\n    data {\n        Id int\n        Param string\n    }\n    conditions {\n        $attorney = DBFind(\"power_of_attorney\").Where({id:$Id, \"address\":$key_id}).Row()\n        if !$attorney {\n            warning \"Power of attorney does not exists\"\n        }\n    }\n    action {\n        var params newParams map keys array i lenKeys int key string\n        params = JSONDecode($attorney[\"params\"])\n        keys = GetMapKeys(params)\n        lenKeys = Len(keys)\n        while i < lenKeys{\n            key = keys[i]\n            if key != $Param{\n                newParams[key] = params[key]\n            }\n            i = i + 1\n        }\n        DBUpdate(\"power_of_attorney\", $Id, {params:\"{}\"})\n        DBUpdate(\"power_of_attorney\", $Id, {params:newParams})\n    }\n}",
            "Type": "contracts"
        },
        {
            "Name": "PoaStore",
            "Conditions": "true",
            "Value": "contract PoaStore {\n    data {\n        Id string \"optional\"\n        MemberId int\n        NameContract string\n        ExpireAt string \"optional\"\n        Params array \"optional\"\n        Values array \"optional\"\n    }\n    conditions {\n        $Id = Int($Id)\n        if $Id > 0 {\n            if !DBFind(\"power_of_attorney\").Where({id:$Id, \"address\":$key_id, delete:0}).One(\"id\") {\n                warning \"Power of attorney does not exists\"\n            }\n        }\n        if !DBFind(\"keys\").WhereId($MemberId).One(\"id\") {\n            warning \"Attorney not found\"\n        }\n\n        if GetContractByName($NameContract) == 0{\n            warning \"Contract not found\"\n        }\n        if Len($Params) > Len($Values) {\n            error \"Incorrect params list\"\n        }\n    }\n    action {\n        // amount_max - максимальная сумма для одноразового перевода\n        // amount_max_day - максимальная сумма для перевода в день\n        // amount_day - переведено в текущий день\n        // date_day - учетный день\n        // amount_max_month - максимальная сумма для перевода в месяц\n        // amount_month переведено в текущий месяц\n        // date_month - учетный месяц\n        \n        var params map i id lenKeys int\n        lenKeys = Len($Params)\n        while i < lenKeys {\n            params[$Params[i]] = $Values[i]\n            i = i + 1\n        }\n        var m map\n        m[\"key_id_attorney\"] = $MemberId\n        m[\"contract\"] = $NameContract\n        m[\"date_expiration\"] = UnixDateTime($ExpireAt)\n        m[\"params\"] = JSONEncode(params)\n        if $Id > 0 {\n            DBUpdate(\"power_of_attorney\", $Id, m)\n        }else{\n            m[\"address\"] = $key_id\n            id = DBInsert(\"power_of_attorney\", m)\n\n            var n map\n            n[\"member_id\"] = $MemberId\n            n[\"sender\"] = 1\n            n[\"text_header\"] = \"You got new power of attorney\"\n            n[\"page_name\"] = \"attorney_add\"\n            n[\"params_map\"] = Sprintf(`{\"id\":\"%v\"}`, id)\n            CallContract(\"NotificationsSend\", n)\n        }\n    }\n}",
            "Type": "contracts"
        }
    ]
}